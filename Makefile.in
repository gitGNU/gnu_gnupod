# Makefile for GNUpod
#
prefix       = @prefix@
exec_prefix  = @exec_prefix@
bindir       = @bindir@
infodir      = @infodir@
mandir       = @mandir@
SHELL        = @SHELL@
top_srcdir   = @top_srcdir@
perlbinary   = @PERL@
podmanbin    = @PODMAN@
pkgver       = @PACKAGE_VERSION@
pkgfname     = gnupod-@PACKAGE_VERSION@
pkgdir       = gnupod-@PACKAGE_VERSION@-noarch-1au
usertoolssrc = $(wildcard src/*.pl)
modulessrc   = $(wildcard src/GNUpod/*.pm)
usertools    = $(usertoolssrc:src/%.pl=%.pl)
usertoolsman = $(usertools:%.pl=%.pl.1.gz)
modules      = $(modulessrc:src/GNUpod/%.pm=GNUpod/%.pm)
buildtargets = $(addprefix build/bin/,$(usertools) $(modules)) $(addprefix build/man/,$(usertoolsman))

# setup build directories and build all tools and libs

prepare : builddirs $(buildtargets) build/info/gnupod.info

build/bin/%.pl build/man/%.pl.1 : src/%.pl
	$(perlbinary) $(top_srcdir)/tools/gnupod_build.pl --perlbin "$(perlbinary)" --perldoc "$(podmanbin)" --man $?

build/man/%.pl.1.gz : build/man/%.pl.1
	gzip -c $? > $?.gz

build/bin/GNUpod/%.pm : src/GNUpod/%.pm
	$(perlbinary) $(top_srcdir)/tools/gnupod_build.pl --perlbin "$(perlbinary)" --target "bin/GNUpod" $?

build/info/%.info: doc/%.info
	$(perlbinary) $(top_srcdir)/tools/gnupod_build.pl --perlbin "$(perlbinary)" --target "info" $?

builddirs: | build

build:
	$(SHELL) $(top_srcdir)/mkinstalldirs $(top_srcdir)/build/bin/GNUpod
	$(SHELL) $(top_srcdir)/mkinstalldirs $(top_srcdir)/build/man
	$(SHELL) $(top_srcdir)/mkinstalldirs $(top_srcdir)/build/info

clean:
	rm -rvf $(top_srcdir)/build

install: prepare
	$(SHELL) $(top_srcdir)/mkinstalldirs $(DESTDIR)$(bindir)
	$(SHELL) $(top_srcdir)/mkinstalldirs $(DESTDIR)$(mandir)/man1
	$(perlbinary) $(top_srcdir)/tools/gnupod_install.pl INSTALL "$(perlbinary)" "$(podmanbin)" "$(bindir)" "$(infodir)" "$(mandir)" "$(DESTDIR)"

uninstall:
	$(perlbinary) $(top_srcdir)/tools/gnupod_install.pl REMOVE  "$(perlbinary)" "$(podmanbin)" "$(bindir)" "$(infodir)" "$(mandir)"

release: clean
	mkdir ../GNUPOD_R && find . | grep -v .git | grep -v \.\#| cpio -pvmd ../GNUPOD_R && cd ../GNUPOD_R && autoconf && rm Makefile && rm config.log config.status && rm -rf autom4te.cache testcases && echo DONE
